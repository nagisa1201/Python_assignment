graph TD
    A[main.py - 程序入口] --> B[初始化 QApplication]
    B --> C[实例化 LibrarySystem]
    C --> D[实例化 LoginDialog]
    D --> E[显示登录界面]
    E --> F{用户操作}
    
    F -->|登录| G[调用 library_service.login]
    F -->|注册| H[调用 library_service.register_user]
    
    G --> I[验证用户身份]
    I -->|成功| J[发射 login_success 信号]
    I -->|失败| K[显示错误信息]
    
    J --> L[关闭登录界面]
    L --> M[实例化 MainWindow]
    M --> N[显示主界面]
    
    N --> O{用户类型判断}
    O -->|普通用户| P[显示基础功能标签页]
    O -->|管理员| Q[显示管理功能标签页]
    
    P --> R[图书查询/浏览]
    P --> S[借阅/归还]
    P --> T[借阅历史]
    
    Q --> U[图书增删改管理]
    Q --> P
    
    R --> V[调用 search_book/show_all_books]
    S --> W[调用 borrow_book/return_book]
    T --> X[显示 borrow_history]
    U --> Y[调用 add_book/modify_book/delete_book]
    
    V --> Z[操作 books/users 数据]
    W --> Z
    Y --> Z
    
    Z --> AA[异步保存数据]
    AA --> AB[更新 JSON 文件]
    AB --> AC[发射信号更新UI]
    
    AC --> AD[更新表格显示]
    AC --> AE[显示操作结果]
    
    style A fill:#e1f5fe
    style C fill:#f3e5f5
    style D fill:#f3e5f5
    style M fill:#f3e5f5
    style Z fill:#fff3e0
    style AB fill:#fff3e0