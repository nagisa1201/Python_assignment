graph TD
    A["程序启动"] --> B["分支执行"]
    
    %% 上位机（UDP服务端）子图封装
    subgraph UDP上位机
        C["配置参数<br/>IP=0.0.0.0、端口=8888<br/>保存路径"]
        D["调用udp_server()函数"]
        E["创建UDP套接字"]
        F["绑定IP和端口"]
        G["打印监听信息"]
        H["阻塞接收数据+客户端地址<br/>(recvfrom(1024))"]
        I["UTF-8解码数据，写入文件<br/>(w模式)"]
        J["编码Success，发送回复<br/>(sendto客户端地址)"]
        K["关闭UDP套接字"]
        L["上位机流程结束"]
        
        %% 上位机内部流程链
        C --> D --> E --> F --> G --> H --> I --> J --> K --> L
    end
    
    %% 下位机（UDP客户端）子图封装
    subgraph UDP下位机
        M["配置参数<br/>文件路径、服务端IP<br/>端口=8888"]
        N["调用 udp_client() 函数"]
        O["创建UDP套接字"]
        P["UTF-8读取文件内容<br/>(r模式)"]
        Q["编码数据，发送至服务端<br/>"]
        R["阻塞接收服务端回复<br/>(recvfrom(1024))"]
        S["解码并打印回复信息"]
        T["关闭UDP套接字"]
        U["下位机流程结束"]
        
        %% 下位机内部流程链
        M --> N --> O --> P --> Q --> R --> S --> T --> U
    end
    
    %% 分支关联子图
    B --> C
    B --> M
    
    %% 核心信息传递（跨子图虚线箭头标注）
    Q -.->|编码后文件数据| H
    J -.->|Success回复数据| R
    
    %% 上位机异常分支
    D --> V["捕获异常<br/>(文件写入/通信错误等)"]
    V --> W["打印异常信息"]
    W --> K
    
    %% 下位机异常分支
    N --> X["捕获异常<br/>(文件未找到/通信错误等)"]
    X --> Y["打印异常信息<br/>(文件未找到/通信异常)"]
    Y --> T
    
    %% 最终统一结束
    L --> Z["程序整体结束"]
    U --> Z