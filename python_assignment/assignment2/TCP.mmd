graph TD
    A["程序启动"] --> B["分支执行"]
    
    %% 上位机子图（极简写法）
    subgraph TCP上位机
        C["配置参数"]
        D["调用tcp_image_server"]
        E["创建套接字+端口复用"]
        F["绑定+监听"]
        G["等待连接"]
        H["接收数据"]
        I["写入文件(wb)"]
        J["发Success"]
        K["关闭连接/套接字"]
        L["上位机结束"]
        
        C-->D-->E-->F-->G-->H-->I-->J-->K-->L
    end
    
    %% 下位机子图（极简写法）
    subgraph TCP下位机
        M["配置参数"]
        N["调用tcp_image_client"]
        O["创建套接字+连接"]
        P["文件校验"]
        Q["读取图像(rb)"]
        R["发送数据"]
        S["收Success"]
        T["关闭套接字"]
        U["下位机结束"]
        
        M-->N-->O-->P-->Q-->R-->S-->T-->U
    end
    
    %% 分支连接
    B-->C
    B-->M
    
    %% 核心交互（直接标注在箭头上）
    R-.->|图片数据| H
    J-.->|Success回复| S
    
    %% 异常分支（极简）
    D-->V["异常→关闭"]
    N-->W["异常→关闭"]
    V-->K
    W-->T
    
    %% 统一结束
    L-->X["程序结束"]
    U-->X