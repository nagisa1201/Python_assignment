graph TD
    A["程序启动"] --> B["分支执行"]
    
    %% 上位机（分块接收）子图
    subgraph TCP上位机
        C["配置参数<br/>IP/端口/保存目录"]
        D["调用tcp_image_server"]
        E["创建套接字+端口复用"]
        F["绑定→监听"]
        G["等待客户端连接"]
        H["接收元信息(文件名、大小)"]
        I["生成唯一文件名(时间戳)"]
        J["算分块数"]
        K["循环接收分块数据"]
        L["写入文件(wb)→发ACK"]
        M["校验完整性→发结果"]
        N["关闭连接+套接字"]
        O["上位机结束"]
        
        C-->D-->E-->F-->G-->H-->I-->J-->K-->L-->M-->N-->O
    end
    
    %% 下位机（分块发送）子图
    subgraph TCP下位机
        P["配置参数<br/>图像路径/服务端IP/端口"]
        Q["调用tcp_image_client"]
        R["创建套接字+设超时"]
        S["连接服务端"]
        T["校验文件存在性"]
        U["获取文件名+大小→发元信息"]
        V["协商成功"]
        W["循环读分块(rb)→发送"]
        X["收ACK确认"]
        Y["收最终结果→打印"]
        Z["关闭套接字"]
        AA["下位机结束"]
        
        P-->Q-->R-->S-->T-->U-->V-->W-->X-->W
        W-->|所有块发完|Y-->Z-->AA
    end
    
    %% 分支关联
    B-->C
    B-->P
    
    %% 核心交互（基础虚线箭头）
    U-.->|元信息|H
    J-.->|协商结果|V
    W-.->|分块数据|K
    L-.->|ACK确认|X
    M-.->|Success/Fail|Y
    
    %% 异常分支（极简）
    D-->AB["异常→关闭+删文件"]
    Q-->AC["异常→关闭套接字"]
    AB-->N
    AC-->Z
    
    %% 统一结束
    O-->AD["程序结束"]
    AA-->AD